{{- $base := .Page.File.BaseFileName -}}
{{- $dir  := strings.TrimSuffix "/" .Page.File.Dir -}}

{{- if not (strings.HasSuffix $base "-SLIDES") -}}
  {{- errorf "extract_slides_from_chapter: current page must end with '-SLIDES'. base=%q file=%q dir=%q" $base .Page.File.Path $dir -}}
{{- end -}}

{{- $srcBase := strings.TrimSuffix "-SLIDES" $base -}}

{{- $srcPath := "" -}}
{{- if $dir -}}
  {{- $srcPath = printf "/%s/%s" $dir $srcBase -}}
{{- else -}}
  {{- $srcPath = printf "/%s" $srcBase -}}
{{- end -}}

{{- $try := slice
    $srcPath
    (strings.TrimPrefix "/" $srcPath)
    (printf "%s.md" $srcPath)
    (printf "%s.md" (strings.TrimPrefix "/" $srcPath))
-}}

{{- if $dir -}}
  {{- $try = $try | append (printf "%s/%s" $dir $srcBase) -}}
  {{- $try = $try | append (printf "%s/%s.md" $dir $srcBase) -}}
{{- end -}}

{{- $src := false -}}
{{- range $try -}}
  {{- if not $src -}}
    {{- $p := . -}}
    {{- $tmp := site.GetPage $p -}}
    {{- if $tmp -}}
      {{- $src = $tmp -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $src -}}
  {{- errorf
      "extract_slides_from_chapter: source page not found.\nslides_file: %q\nbase: %q\ndir: %q\nsrcBase: %q\nderived_srcPath: %q\ntried:\n- %s"
      .Page.File.Path
      $base
      $dir
      $srcBase
      $srcPath
      (delimit $try "\n- ")
  -}}
{{- end -}}

{{- $src.Scratch.Set "RENDERING_SLIDES" true -}}
{{- $src.Scratch.Set "reveal_slides" (slice) -}}

{{- $noop := $src.RenderString (dict "display" "block" "renderShortcodes" true) $src.RawContent -}}

{{- $collected := $src.Scratch.Get "reveal_slides" | default (slice) -}}
{{- if eq (len $collected) 0 -}}
  {{- errorf "extract_slides_from_chapter: 0 slides collected from source=%q (derived=%q). This usually means RenderString did not execute shortcodes in CI." $src.File.Path $srcPath -}}
{{- end -}}

{{- .Page.Scratch.Set "reveal_slides" ($src.Scratch.Get "reveal_slides" | default (slice)) -}}

{{- $src.Scratch.Delete "RENDERING_SLIDES" -}}

