{{- $base := .Page.File.BaseFileName -}}
{{- $dir  := strings.TrimSuffix "/" .Page.File.Dir -}}

{{- if not (strings.HasSuffix $base "-SLIDES") -}}
  {{- errorf "extract_slides_from_chapter: current page must end with '-SLIDES'. base=%q file=%q dir=%q" $base .Page.File.Path $dir -}}
{{- end -}}

{{- $srcBase := strings.TrimSuffix "-SLIDES" $base -}}

{{- $srcPath := "" -}}
{{- if $dir -}}
  {{- $srcPath = printf "/%s/%s" $dir $srcBase -}}
{{- else -}}
  {{- $srcPath = printf "/%s" $srcBase -}}
{{- end -}}

{{- $try := slice
    $srcPath
    (strings.TrimPrefix "/" $srcPath)
    (printf "%s.md" $srcPath)
    (printf "%s.md" (strings.TrimPrefix "/" $srcPath))
-}}

{{- if $dir -}}
  {{- $try = $try | append (printf "%s/%s" $dir $srcBase) -}}
  {{- $try = $try | append (printf "%s/%s.md" $dir $srcBase) -}}
{{- end -}}

{{- $src := false -}}
{{- range $try -}}
  {{- if not $src -}}
    {{- $p := . -}}
    {{- $tmp := site.GetPage $p -}}
    {{- if $tmp -}}
      {{- $src = $tmp -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $src -}}
  {{- errorf
      "extract_slides_from_chapter: source page not found.\nslides_file: %q\nbase: %q\ndir: %q\nsrcBase: %q\nderived_srcPath: %q\ntried:\n- %s"
      .Page.File.Path
      $base
      $dir
      $srcBase
      $srcPath
      (delimit $try "\n- ")
  -}}
{{- end -}}

{{- if .Site.Params.debugSlides -}}
  {{- warnf "extract_slides_from_chapter: slides=%q src=%q (layout slides=%q src.layout=%q) srcPath=%q base=%q dir=%q"
      .Page.File.Path
      $src.File.Path
      .Page.Layout
      $src.Layout
      $srcPath
      $base
      $dir
  -}}
{{- end -}}

{{- hugo.Store.Set "RENDERING_SLIDES" true -}}
{{- hugo.Store.Set "reveal_slides" (slice) -}}
{{- hugo.Store.Set "reveal_seen" (dict) -}}

{{- if .Site.Params.debugSlides -}}
  {{- warnf "extract_slides_from_chapter: set store RENDERING_SLIDES=%v" (hugo.Store.Get "RENDERING_SLIDES") -}}
{{- end -}}

{{- $noop := $src.RenderString (dict "display" "block" "renderShortcodes" true) $src.RawContent -}}

{{- $collected := hugo.Store.Get "reveal_slides" | default (slice) -}}

{{- if .Site.Params.debugSlides -}}
  {{- warnf "extract_slides_from_chapter: after RenderString collected=%d storeFlag=%v"
      (len $collected)
      (hugo.Store.Get "RENDERING_SLIDES")
  -}}
{{- end -}}

{{- if eq (len $collected) 0 -}}
  {{- errorf "extract_slides_from_chapter: 0 slides collected from %q (slides=%q). slide shortcodes were not executed under RenderString." $src.File.Path .Page.File.Path -}}
{{- end -}}

{{- .Page.Scratch.Set "reveal_slides" $collected -}}

{{- hugo.Store.Delete "RENDERING_SLIDES" -}}
{{- hugo.Store.Delete "reveal_slides" -}}
{{- hugo.Store.Delete "reveal_seen" -}}

{{- if .Site.Params.debugSlides -}}
  {{- warnf "extract_slides_from_chapter: cleared store flags for slides=%q" .Page.File.Path -}}
{{- end -}}
