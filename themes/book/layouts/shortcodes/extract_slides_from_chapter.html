{{- $base := .Page.File.BaseFileName -}}
{{- $dir  := strings.TrimSuffix "/" .Page.File.Dir -}}

{{- if not (strings.HasSuffix $base "-SLIDES") -}}
  {{- errorf "extract_slides_from_chapter: current page must end with '-SLIDES'. base=%q file=%q dir=%q" $base .Page.File.Path $dir -}}
{{- end -}}

{{- $deckID := .Page.File.Path -}}
{{- $doneKey := printf "REVEAL_EXTRACT_DONE::%s" $deckID -}}
{{- if hugo.Store.Get $doneKey -}}
  {{- /* prevent duplicate extraction */ -}}
  {{- return -}}
{{- end -}}
{{- hugo.Store.Set $doneKey true -}}

{{- $srcBase := strings.TrimSuffix "-SLIDES" $base -}}

{{- $srcPath := "" -}}
{{- if $dir -}}
  {{- $srcPath = printf "/%s/%s" $dir $srcBase -}}
{{- else -}}
  {{- $srcPath = printf "/%s" $srcBase -}}
{{- end -}}

{{- $try := slice
    $srcPath
    (strings.TrimPrefix "/" $srcPath)
    (printf "%s.md" $srcPath)
    (printf "%s.md" (strings.TrimPrefix "/" $srcPath))
-}}

{{- if $dir -}}
  {{- $try = $try | append (printf "%s/%s" $dir $srcBase) -}}
  {{- $try = $try | append (printf "%s/%s.md" $dir $srcBase) -}}
{{- end -}}

{{- $src := false -}}
{{- range $try -}}
  {{- if not $src -}}
    {{- $p := . -}}
    {{- $tmp := site.GetPage $p -}}
    {{- if $tmp -}}
      {{- $src = $tmp -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $src -}}
  {{- errorf
      "extract_slides_from_chapter: source page not found.\nslides_file: %q\nbase: %q\ndir: %q\nsrcBase: %q\nderived_srcPath: %q\ntried:\n- %s"
      .Page.File.Path
      $base
      $dir
      $srcBase
      $srcPath
      (delimit $try "\n- ")
  -}}
{{- end -}}

{{- hugo.Store.Set "RENDERING_SLIDES" true -}}
{{- hugo.Store.Set "REVEAL_DECK_ID" $deckID -}}
{{- hugo.Store.Set "reveal_slides" (slice) -}}

{{- $noop := $src.RenderString (dict "display" "block" "renderShortcodes" true) $src.RawContent -}}

{{- $new := hugo.Store.Get "reveal_slides" | default (slice) -}}

{{- hugo.Store.Delete "RENDERING_SLIDES" -}}
{{- hugo.Store.Delete "REVEAL_DECK_ID" -}}
{{- hugo.Store.Delete "reveal_slides" -}}

{{- if eq (len $new) 0 -}}
  {{- errorf "extract_slides_from_chapter: 0 slides collected from %q (slides=%q)" $src.File.Path .Page.File.Path -}}
{{- end -}}

{{- /* Append to existing slides on the deck page (keeps title slide, etc.) */ -}}
{{- $existing := .Page.Scratch.Get "reveal_slides" | default (slice) -}}
{{- $all := $existing | append $new -}}

{{- /* Stable dedup: ignore whitespace differences */ -}}
{{- $uniq := slice -}}
{{- $seen := dict -}}
{{- range $all -}}
  {{- $s := . -}}
  {{- $norm := replaceRE "\\s+" "" $s -}}
  {{- $h := sha1 $norm -}}
  {{- if not (index $seen $h) -}}
    {{- $uniq = $uniq | append $s -}}
    {{- $seen = merge $seen (dict $h true) -}}
  {{- end -}}
{{- end -}}

{{- .Page.Scratch.Set "reveal_slides" $uniq -}}
