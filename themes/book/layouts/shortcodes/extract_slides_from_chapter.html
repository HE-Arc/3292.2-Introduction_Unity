{{- $base := .Page.File.BaseFileName -}}
{{- $dir  := strings.TrimSuffix "/" .Page.File.Dir -}}

{{- if not (strings.HasSuffix $base "-SLIDES") -}}
  {{- errorf "extract_slides_from_chapter: current page must end with '-SLIDES'. base=%q file=%q dir=%q" $base .Page.File.Path $dir -}}
{{- end -}}

{{- $srcBase := strings.TrimSuffix "-SLIDES" $base -}}

{{- $srcPath := "" -}}
{{- if $dir -}}
  {{- $srcPath = printf "/%s/%s" $dir $srcBase -}}
{{- else -}}
  {{- $srcPath = printf "/%s" $srcBase -}}
{{- end -}}

{{- $try := slice
    $srcPath
    (strings.TrimPrefix "/" $srcPath)
    (printf "%s.md" $srcPath)
    (printf "%s.md" (strings.TrimPrefix "/" $srcPath))
-}}

{{- if $dir -}}
  {{- $try = $try | append (printf "%s/%s" $dir $srcBase) -}}
  {{- $try = $try | append (printf "%s/%s.md" $dir $srcBase) -}}
{{- end -}}

{{- $src := false -}}
{{- range $try -}}
  {{- if not $src -}}
    {{- $p := . -}}
    {{- $tmp := site.GetPage $p -}}
    {{- if $tmp -}}
      {{- $src = $tmp -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $src -}}
  {{- errorf
      "extract_slides_from_chapter: source page not found.\nslides_file: %q\nbase: %q\ndir: %q\nsrcBase: %q\nderived_srcPath: %q\ntried:\n- %s"
      .Page.File.Path
      $base
      $dir
      $srcBase
      $srcPath
      (delimit $try "\n- ")
  -}}
{{- end -}}

{{- $deckID := replace .Page.File.Path "\\" "/" -}}
{{- $chapterID := replace $src.File.Path "\\" "/" -}}

{{- $flagKey := printf "RENDERING_SLIDES::%s" $deckID -}}
{{- $bufKey  := printf "REVEAL_SLIDES::%s" $deckID -}}
{{- $mapKey  := printf "CHAPTER2DECK::%s" $chapterID -}}

{{- hugo.Store.Set $mapKey $deckID -}}
{{- hugo.Store.Set $flagKey true -}}
{{- hugo.Store.Set $bufKey (slice) -}}

{{- $noop := $src.RenderString (dict "display" "block" "renderShortcodes" true) $src.RawContent -}}

{{- $collected := hugo.Store.Get $bufKey | default (slice) -}}

{{- hugo.Store.Delete $mapKey -}}
{{- hugo.Store.Delete $flagKey -}}
{{- hugo.Store.Delete $bufKey -}}

{{- if eq (len $collected) 0 -}}
  {{- errorf "extract_slides_from_chapter: 0 slides collected from %q (slides=%q)" $src.File.Path .Page.File.Path -}}
{{- end -}}

{{- $existing := .Page.Scratch.Get "reveal_slides" | default (slice) -}}
{{- $all := $existing | append $collected -}}

{{- $uniq := slice -}}
{{- $seen := dict -}}
{{- range $all -}}
  {{- $s := . -}}
  {{- $norm := replaceRE "\\s+" "" $s -}}
  {{- $h := sha1 $norm -}}
  {{- if not (index $seen $h) -}}
    {{- $uniq = $uniq | append $s -}}
    {{- $seen = merge $seen (dict $h true) -}}
  {{- end -}}
{{- end -}}

{{- .Page.Scratch.Set "reveal_slides" $uniq -}}
